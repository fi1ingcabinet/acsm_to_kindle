<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Create .zip files using JavaScript. Provides a simple API to place any content generated by JavaScript into a .zip file for your users.">
    <title>Reading a local file with the File API</title>

    <!--
    Any version of jQuery will do (it's just to write some examples), this one
    happens to be available in our tests.
    -->
    <script type="text/javascript" src="Reading%20a%20local%20file%20with%20the%20File%20API_files/jquery-1.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="Reading%20a%20local%20file%20with%20the%20File%20API_files/bootstrap.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="Reading%20a%20local%20file%20with%20the%20File%20API_files/bootstrap-theme.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="Reading%20a%20local%20file%20with%20the%20File%20API_files/bootstrap.js"></script>

    <link rel="stylesheet" href="Reading%20a%20local%20file%20with%20the%20File%20API_files/pygments.css">
    <link rel="stylesheet" href="Reading%20a%20local%20file%20with%20the%20File%20API_files/main.css">

    <script type="text/javascript" src="Reading%20a%20local%20file%20with%20the%20File%20API_files/jszip.js"></script>

    <script type="text/javascript" src="Reading%20a%20local%20file%20with%20the%20File%20API_files/jszip-utils.js"></script>
    <!--
    Mandatory in IE 6, 7, 8 and 9.
    -->
    <!--[if IE]>
    <script type="text/javascript" src="//stuk.github.io/jszip-utils/dist/jszip-utils-ie.js"></script>
    <![endif]-->


    <script type="text/javascript" src="Reading%20a%20local%20file%20with%20the%20File%20API_files/FileSaver.js"></script>

        <script>
        // copied from elsewhere in cryptico            
function base64tobase16(s) {
    var ret = "";
    var i;
    var k = 0;
    var slop;
    var base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
    for (i = 0; i < s.length; ++i)
    {
        if (s.charAt(i) == "=") break;
        v = base64Chars.indexOf(s.charAt(i));
        if (v < 0) continue;
        if (k == 0)
        {
            ret += int2char(v >> 2);
            slop = v & 3;
            k = 1;
        }
        else if (k == 1)
        {
            ret += int2char((slop << 2) | (v >> 4));
            slop = v & 0xf;
            k = 2;
        }
        else if (k == 2)
        {
            ret += int2char(slop);
            ret += int2char(v >> 2);
            slop = v & 3;
            k = 3;
        }
        else
        {
            ret += int2char((slop << 2) | (v >> 4));
            ret += int2char(v & 0xf);
            k = 0;
        }
    }
    if (k == 1) ret += int2char(slop << 2);
    return ret;
}
function int2char(n) {
    return BI_RM.charAt(n);
}
var BI_RM = "0123456789abcdefghijklmnopqrstuvwxyz";
            
            
    </script>
    
    </head>
 <body>

    <h1>Welcome to the encrypted epub to kindle site</h1>
    <p>In this page we will input an ebook from Adobe Digital Editions and output a file we can email to a kindle in book format.</p>
    
    <h2>First import the book:</h2>
    <p>To do this we need to upload an epub file and unzip it. I will use javascript JSZIP. The example is in the GitHub under JSZip.</p>
    <script>
        
    </script>

    <input type="file" id="file" name="file" multiple=""><br>
    <input type="submit" id="subbut" style="display:block">
    <div id="result_block" class="hidden">
    <h3>Content :</h3>
    <div id="result"></div>
</div>
    
<script type="text/javascript">
    // This comes from the JSZip example: https://stuk.github.io/jszip/documentation/examples/read-local-file-api.html
    (function () {
        //console.log("test");
      if (!window.FileReader || !window.ArrayBuffer) {
        $("#error_block").removeClass("hidden").addClass("show");
        return;
      }

    var $result = $("#result");
    $("#file").on("change", function(evt) {
    //$("submit").click(function(evt){   
        console.log("test");
        document.getElementById("subbut").style.display = "block";

        // remove content
        console.log("Test here");
        $result.html("");
        // be sure to show the results
        $("#result_block").removeClass("hidden").addClass("show");

        // Closure to capture the file information.
        function handleFile(f) {
            var $title = $("<h4>", {
                text : f.name
            });
            var $fileContent = $("<ul>");
            $result.append($title);
            $result.append($fileContent);

            var dateBefore = new Date();
            JSZip.loadAsync(f)                                   // 1) read the Blob
            .then(function(zip) {
                console.log("test");
                var dateAfter = new Date();
                $title.append($("<span>", {
                    "class": "small",
                    text:" (loaded in " + (dateAfter - dateBefore) + "ms)"
                }));

                zip.forEach(function (relativePath, zipEntry) {  // 2) print entries
                    $fileContent.append($("<li>", {
                        text : zipEntry.name
                    }));
                    //if (1==1){
                    //    return;}
                    zipEntry.async("base64")
                    //.then(function (data64) {
                    .then(function (binary) {

                        if (zipEntry.name=="EPUB/images/img_0013.png"){
                            var dataURI = binary;
                            console.log(zipEntry.name);
                            console.log(dataURI);
                            console.log(base64tobase16(dataURI));
                        }
                        });

                });

            }, function (e) {
                $result.append($("<div>", {
                    "class" : "alert alert-danger",
                    text : "Error reading " + f.name + ": " + e.message
                }));
            });
        }

        var files = evt.target.files;
        for (var i = 0; i < files.length; i++) {
            handleFile(files[i]);
        }
    });



    })();
</script>


</body>
</html>